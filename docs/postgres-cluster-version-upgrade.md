# Crunchy postgres-cluster major version upgrade with Helm

## Steps

Pre-reqs:

- Ensure full backups have been taken with the pg cluster

  local backup can be taken with

  ```
  oc exec <db-pod-name> -c <db-container-name> -- pg_dump <database-name> > dump.sql
  oc exec <db-pod-name> -c <db-container-name> -- pg_dumpall -g > dump_roles.sql

  ```

- Ensure the latest backup can be restored (see CIF job)
- For -test: restore prod data to make sure the upgrade doesn't break prod

1.  Create a new chart with:

- PGUpgrade object
- Job that Annotates the existing cluster: <br>
  with `postgres-operator.crunchydata.com/allow-upgrade="<cluster-name>"`
- Job that shuts down the existing cluster <br>
  something like `kubectl patch PostgresOperator <thename> --patch '{"spec": {"shutdown": true}}'`
- Job that waits for the PGUpgrade `status.conditions` success AND postgres cluster `status.postgresVersion` 16
- KNPs, SA, Role and Rolebinding to let us do those things (see patroni migration chart)

2. Amend the helm chart of the original cluster and deploy (release ready to go, not deployed yet)

- PG version 16
- Shutdown false

3. Deploy the upgrade chart from step 1. on the namespace where the cluster exists

   > [!NOTE]
   >
   > - Use a short release name to avoid maxxing out the 63-character length on openshift job names
   > - Deploy with a timeout long enough (30 or 60 min.) to allow the cluster to shut itself down.
   > - If the `helm deploy` times out, no panic, you'll just need to manually restart the cluster and set its postgresVersion value
   > - kubernetes version needs to be the one of the cluster. run `oc version` for details

4. Deploy the release from step 2.

5. Post-cleanup

- look at logs for warnings
- look at the scripts generated by pg_upgrade (in the /pgdata folder)
- uninstall the upgrade chart (or not if you'd like to keep the objects around)

## Possible errors and troubleshooting

- if the upgrade hangs:

  > the release name was probably too long. the PGUpgrade object is very hard to debug

- if the upgrade fails:

  > remove job hooks
  > remove the /pgdata/pg16 folder from leader PVC

- if you forgot to extend the timeout

  > set the shutdown to false

- if your database has roles without an `ADMIN` clause
  > PSQL: `grant <role1>,<role2> to <user> with admin true;`
